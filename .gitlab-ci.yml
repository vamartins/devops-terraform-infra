include:
  - project: vagner.samm/common-pipeline
    ref: main
    file:
      - templates/common-variables.yml
      - templates/infra-pipelines/terraform-pipeline.yml
      - templates/security/terraform-tools.yml

variables:
  TF_ROOT: $CI_PROJECT_DIR/infra/
  TF_VAR_application_name: $CI_PROJECT_NAME
  TF_VAR_aws_region: $AWS_REGION

.dev_variables: &dev_variables
  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_DEV
  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_DEV
  TF_VAR_environment: dev
  TF_VAR_aws_account_number: $AWS_ACCOUNT_ID_DEV

.test_variables: &test_variables
  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_TEST
  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_TEST
  TF_VAR_environment: test
  TF_VAR_aws_account_number: $AWS_ACCOUNT_ID_TEST

stages:
  - validate
  - dev
  - test
  - destroy

# tfsec:
#   extends: .tfsec
#   stage: validate
#   rules:
#     - if: $CI_COMMIT_BRANCH == "main"

# checkov:
#   extends: .checkov
#   stage: test
#   only:
#     - merge_requests

tflint:
  extends: .tflint
  stage: validate
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

tf_plan_dev:
  extends: .tf_plan
  stage: dev
  variables:
    <<: *dev_variables
  environment:
    name: develop
  artifacts:
    paths:
      - planfile
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

tf_deploy_dev:
  extends: .tf_deploy
  stage: dev
  variables:
    <<: *dev_variables
  environment:
    name: develop
  dependencies:
    - tf_plan_dev
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual

promote_test:
  extends: .promote_tf
  stage: test
  variables:
    <<: *test_variables
  environment:
    name: testing
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual

tf_destroy_dev:
  extends: .tf_destroy
  stage: destroy
  variables:
    <<: *dev_variables
  environment:
    name: develop
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - when: never

tf_destroy_test:
  extends: .tf_destroy
  stage: destroy
  variables:
    <<: *test_variables
  environment:
    name: testing
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - when: never